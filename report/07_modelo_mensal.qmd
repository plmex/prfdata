---
title: "Início da criação do modelo mensal estadual"
format: html
editor: visual
---

## Coleta de dados

```{r}
library(tidyverse)
library(roadtrafficdeaths)
library(here)
```

```{r}
rtdeaths |> head()
```

```{r}
mortes <- rtdeaths |> 
  mutate(mes_ocorrencia = month(data_ocorrencia)) |> 
  count(mes_ocorrencia, ano_ocorrencia) |> 
  arrange(ano_ocorrencia) |> 
  mutate(data = paste0(as.character(mes_ocorrencia),
                       "-",
                       as.character(ano_ocorrencia)),
         data = my(data))

mortes
```

```{r}
ggplot(mortes, aes(x = data, y = n)) + geom_line()
```

```{r}
library(forecast)
tseries <- ts(data = mortes$n, start = c(1996,1), end = c(2021,12), frequency = 12)
plot(tseries)

fit <- stl(tseries, s.window = "periodic")
plot(fit)
monthplot(tseries)
```

```{r}
tseries_dec <- tseries |> decompose()

autoplot(tseries_dec$seasonal, )
autoplot(tseries_dec$trend, )
autoplot(tseries_dec$random, )
```

```{r}
prf_filepaths <- paste0(
  here("data-raw","datatran//"),
  list.files(here("data-raw/datatran"))
)

prf_filepaths
```

```{r}
prf_temp <- lapply(prf_filepaths, 
                read_delim, 
                delim = ";", 
                locale = locale(decimal_mark = ",",
                                encoding = "Latin1",
                                date_format = "%d/%m/%Y"))

prf_temp[[10]] <-  prf_temp[[10]] |> mutate(data_inversa = dmy(data_inversa))
```

```{r}
prf <- prf_temp |> lapply(select, data_inversa, uf, causa_acidente, tipo_acidente, classificacao_acidente, pessoas, mortos, feridos)

prf <- reduce(prf, full_join)
```

```{r}
prf_data <- prf |> mutate(
  ano = year(data_inversa),
  mes = month(data_inversa),
  classificacao_acidente = case_when(
    classificacao_acidente %in% c("(null)","Ignorado",NA) & mortos > 0 ~ "Com Vítimas Fatais",
    classificacao_acidente %in% c("(null)","Ignorado",NA) & mortos == 0 & feridos > 0 ~ "Com Vítimas Feridas",
    classificacao_acidente %in% c("(null)","Ignorado",NA) & mortos == 0 & feridos == 0 ~ "Sem Vítimas",
    TRUE ~ classificacao_acidente
  )
)
```

```{r}
prf_data |> 
  group_by(mes, ano) |> 
  summarise(
    acidentes = n(),
    acidentes_fatais = sum(classificacao_acidente == "Com Vítimas Fatais"),
    feridos = sum(feridos),
    mortes = sum(mortos)
  ) |> 
  arrange(ano)
```




