---
title: "Modelo Preditivo de Óbitos no Trânsito Brasileiro"
subtitle: "Modelagem orientada a dados relacionados à segurança viária para o reconhecimento de padrões e previsão de óbitos no trânsito"
lang: pt-br
format: 
  revealjs: 
    theme: [default, reveal.scss]
    logo: "onsv_icone.png"
    transition: slide
author: 
  - name: João Pedro Melani Saraiva
    affiliations:
      - ref: obs 
  - name: Pedro Augusto Borges dos Santos
    affiliations:
      - ref: obs
affiliations: 
  - id: obs
    number: 1
    name: Observatório Nacional de Segurança Viária
bibliography: references.bib
csl: associacao-brasileira-de-normas-tecnicas.csl
editor_options: 
  chunk_output_type: console
---

# Introdução

```{r}
#| include: false

library(tidyverse)
library(onsvplot)
library(roadtrafficdeaths)
library(plotly)
library(here)
library(ggcorrplot)
library(gt)

load(here("data","tabela_total.rda"))
load(here("data","tabela_total_mensal.rda"))
```

## Motivação

-   Presente cenário da segurança viária mundial e brasileira [@worldhealthorganization2023];

-   Diversos países com demanda por modelos estatísticos preditivos [@rodríguez2020];

-   Defasagem nas fontes de dados: Sistema de Mortalidade - DataSUS;

-   Ocorrência de vítimas fatais no trânsito se relaciona com diversos atributos estruturais, socioeconômicos e ambientais [@zhong-xiang2014].

## Referenciais Teóricos

-   Brasil falhou na *Primeira Década de Ação pela Segurança no Trânsito*, como previsto em @blumenberg2018;

-   Desenvolvimento do PNATRANS;

-   Modelos Preditivos na Literatura:

    -   Modelos Lineares Multivariados [@blumenberg2018; @cai2015];

    -   Cadeia de Markov [@seneta1996; @jin2020];

    -   Modelos Autoregressivos [@al-ghamdi1995];

    -   Redes Neurais Artificiais [@jafari2015].

## Objetivo

-   Desenvolver um modelo capaz de prever óbitos em trânsito;

-   Explicar a influência das variáveis;

-   Avaliar desempenho de diferentes abordagens (Determinística e Temporal);

-   Avaliar o desempenho de diferentes modelos e escalas temporais.

# Metodologia

## Coleta de dados

-   Dados coletados de diversas fontes, com diferentes escalas de tempo;

-   Diferentes modelos são ajustados de acordo com a disponibiliade de dados:

::: panel-tabset
### Escala de tempo

```{r}
data.frame(
  Categoria = c("PIB", "População", "Sinistros em rodovias federais", "Condutores Habilitados", "Frota veicular", "Óbitos em sinistros de trânsito"),
  Anual = c(T, T, T, T, T, T),
  Trimestral = c(T, F, T, F, T, T),
  Mensal = c(T, F, T, F, T, T)
) |> 
  gt(rowname_col = "Categoria") |> 
  tab_options(
    column_labels.background.color = onsv_palette$blue,
    column_labels.font.weight = "bold"
  ) |>
  tab_style(style = cell_text(color = onsv_palette$blue),
            locations = cells_title()) |> 
  sub_values(values = T, replacement = "\u2713") |> 
  sub_values(values = F, replacement = "\u2717") |> 
  tab_options(table.font.size = 24) |> 
  tab_stubhead("Variáveis") |> 
  tab_spanner(label = "Resolução Temporal", columns = ends_with("l")) |> 
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_stubhead()) |> 
  tab_style(
    style = "vertical-align:middle",
    locations = cells_stubhead()
  )
```

### Fontes de dados

-   **PIB**: @bancocentraldobrasil2023;
-   **População**: @ministériodasaúde2023b;
-   **Sinistros em rodovias federais**: @políciarodoviáriafederal2023;
-   **Condutores habilitados**: @ministériodostransporte2023;
-   **Frota veicular**: @ministériodostransportes2023;
-   **Óbitos em trânsito**: @ministériodasaúde2023a, coletado utilizando pacote `microdatasus` [@microdatasus] da linguagem de programação estatística *R*.
:::

## Modelos

-   Disponibilidade de dados é um grande obstáculo na confecção de modelos mais complexos e custosos;

-   Diferentes abordagens são testadas a fim de encontrar a metodologia ideal para modelagem da fatalidade dos sinistros.

```{r}
data.frame(
  modelo = c(
    "Regressão Linear",
    "Random Forest",
    "SARIMA",
    "Suavização Exponencial"
  ),
  anual = c(T, F, F, F),
  trimestral = c(T, F, F, F),
  mensal = c(T, T, T, T)
) |>
  mutate(tipo = case_when(
    modelo %in% c("Regressão Linear", "Random Forest") ~ "Determinístico",
    modelo %in% c("SARIMA", "Suavização Exponencial") ~ "Série Temporal"
  ), .before = 1) |>
  rename_with(str_to_title) |>
  gt(rowname_col = "Modelo", groupname_col = "Tipo") |>
  tab_options(
    column_labels.background.color = onsv_palette$blue,
    column_labels.font.weight = "bold"
  ) |>
  tab_style(style = cell_text(color = onsv_palette$blue),
            locations = cells_title()) |>
  sub_values(values = T, replacement = "\u2713") |>
  sub_values(values = F, replacement = "\u2717") |>
  tab_options(table.font.size = 26) |>
  tab_stubhead("Modelos") |>
  tab_spanner(label = "Resolução Temporal", columns = ends_with("l")) |>
  tab_style(style = cell_text(align = "center"),
            locations = cells_stubhead()) |>
  tab_style(style = "vertical-align:middle",
            locations = cells_stubhead()) |> 
  tab_style(style = cell_fill(color = "grey90"),
            locations = cells_group())
```

## Análise de Série Temporal x Análise Determinística

- Duas abordagens esatísticas abordadas no estudo.

- Análise de Série Temporal:
  - Conjunto de dados em uma sequência cronológica;
  - Sazonalidade e tendência;
  - Autocorrelação e autorregressão;
  - Média móvel.
- Análise Determinística:
  - Algoritmos de Regressão;
  - Multivariados;
  - Independem da sequência cronológica.
  
# Resultados e Discussão

## Análise Exploratória de Dados

- Efetuada para todas as variáveis;
- Dados históricos de óbitos no trânsito:

::: panel-tabset

### Anual
```{r}
rtdeaths |> 
  summarise(.by = ano_ocorrencia, obitos = n()) |> 
  drop_na() |> 
  plot_ly(x = ~ano_ocorrencia, y = ~obitos, 
          type = "scatter", 
          mode = "lines",
          line = list(color = onsv_palette$blue),
          text = ~paste("Vítimas:", obitos, "<br>Ano:", ano_ocorrencia),
          hoverinfo = "text",
          width = 1000, height = 400) |> 
  layout(yaxis = list(exponentformat = "none",
                      title = "Óbitos"),
         xaxis = list(title = "Data"),
         separators = ",.")
```

### Trimestral
```{r}
rtdeaths |> 
  arrange(data_ocorrencia) |> 
  mutate(trimestre = quarter(data_ocorrencia, type = "date_last"), 
         .before = 1) |> 
  summarise(.by = trimestre, obitos = n()) |> 
  drop_na() |> 
  plot_ly(x = ~trimestre, y = ~obitos,
          type = "scatter",
          mode = "lines",
          line = list(color = onsv_palette$blue),
          text = ~paste("Vítimas:", obitos, "<br>Trimestre:", trimestre),
          hoverinfo = "text",
          width = 1000, height = 400) |> 
  layout(yaxis = list(exponentformat = "none",
                      title = "Óbitos"),
         xaxis = list(title = "Data"),
         separators = ",.")
```

### Mensal
```{r}
rtdeaths |> 
  arrange(data_ocorrencia) |> 
  mutate(data = ym(paste0(ano_ocorrencia,"-",month(data_ocorrencia))),
         .before = 1) |> 
  summarise(.by = data, obitos = n()) |> 
  drop_na() |>
  plot_ly(x = ~data, y = ~obitos,
          type = "scatter",
          mode = "lines",
          line = list(color = onsv_palette$blue),
          text = ~paste("Vítimas:", obitos, "<br>Mês:", data),
          hoverinfo = "text",
          width = 1000, height = 400) |> 
  layout(yaxis = list(exponentformat = "none",
                      title = "Óbitos"),
         xaxis = list(title = "Data"),
         separators = ",.")
```

:::

## Correlação

- Correlação não-paramétrica de Spearman;
- Variação da correlação em relação da resolução temporal.

:::panel-tabset

### Anual
```{r}
#| fig-height: 4
#| fig-align: center

cor_spearman_anual <- df_total |> 
  drop_na() |> 
  select(-c(quilometragem_10_bilhoes, mortos_por_pop, ano)) |> 
  rename(
    `Óbitos` = mortes,
    Automóveis = automovel,
    Motocicletas = motocicleta,
    `Veículos Totais` = veiculos_total,
    PIB = pib,
    `População` = populacao,
    Sinistros = qnt_acidentes,
    `Sinistros fatais` = qnt_acidentes_fatais,
    Feridos = qnt_feridos,
    Condutores = condutores,
    `Mortes PRF` = qnt_mortos
  ) |> 
  cor(method = "spearman")

ggcorrplot(
  cor_spearman_anual,
  lab_col = "white",
  type = "lower",
  lab = T,
  hc.order = T,
  lab_size = 2.5, 
  tl.srt = 60,
  tl.cex = 12, 
  legend.title = "Correlação",
  colors = c(onsv_palette$blue, "white", onsv_palette$red)
)
```

### Trimestral
```{r}
#| fig-height: 4
#| fig-align: center

cor_spearman_trimestral <- dados_mensais |> 
  mutate(data = quarter(data, type = "date_last")) |> 
  summarise(
    .by = data,
    veiculos = last(veiculos),
    automovel = last(automovel),
    motocicleta = last(motocicleta),
    mortes = sum(mortes),
    pib = sum(pib),
    acidentes = sum(acidentes),
    acidentes_fatais = sum(acidentes_fatais),
    feridos = sum(feridos),
    mortes_prf = sum(mortes_prf)
  ) |> 
  select(-data) |> 
  rename(
    `Óbitos` = mortes,
    Automóveis = automovel,
    Motocicletas = motocicleta,
    `Veículos Totais` = veiculos,
    PIB = pib,
    Sinistros = acidentes,
    `Sinistros fatais` = acidentes_fatais,
    Feridos = feridos,
    `Mortes PRF` = mortes_prf
  ) |> 
  cor(method = "spearman")

ggcorrplot(
  cor_spearman_trimestral,
  lab_col = "white",
  type = "lower",
  lab = TRUE, 
  hc.order = T,
  lab_size = 2.5, 
  tl.srt = 60,
  tl.cex = 12, 
  legend.title = "Correlação",
  colors = c(onsv_palette$blue, "white", onsv_palette$red)
)
```

### Mensal
```{r}
#| fig-height: 4
#| fig-align: center

cor_spearman_mensal <- dados_mensais |> 
  select(-data) |> 
  rename(
    `Óbitos` = mortes,
    Automóveis = automovel,
    Motocicletas = motocicleta,
    `Veículos Totais` = veiculos,
    PIB = pib,
    Sinistros = acidentes,
    `Sinistros fatais` = acidentes_fatais,
    Feridos = feridos,
    `Mortes PRF` = mortes_prf
  ) |> 
  cor(method = "spearman")

ggcorrplot(
  cor_spearman_mensal,
  lab_col = "white",
  type = "lower",
  lab = TRUE, 
  hc.order = T,
  lab_size = 2.5, 
  tl.srt = 60,
  tl.cex = 12, 
  legend.title = "Correlação",
  colors = c(onsv_palette$blue, "white", onsv_palette$red)
)
```

:::

## Resultados dos modelos



## Comparação entre modelos

# Conclusão

## Referências
