---
title: "Modelo Preditivo de Mortes Viárias Anuais no Brasil"
format: 
  html:
    editor: visual
    fig-width: 6
    fig-height: 3.5
    dpi: 300
knitr: 
  opts_chunk: 
    fig.align: center
bibliography: references.bib
number-sections: true
toc: true
toc-title: Sumário
theme: lux
---

```{r include=FALSE}
# packages
library(tidyverse)
library(ggcorrplot)
library(onsvplot)
library(knitr)
library(here)
library(tidymodels)

# load dos dados
load(here("data","tabela_total.rda"))

# supressão dos warnings
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

## Introdução

O presente cenário mundial acerca de mortes e lesões relacionadas a sinistros viários posam sérios desafios à segurança pública global, e as tendências evidenciadas pelos dados contemporâneos indicam que esta realidade perdura pelo futuro observável [@worldhealthorganization2018]. Sendo uma das causas de mortes evitáveis mais comuns no mundo, as ocorrências de acidentes afetam principalmente pedestres, ciclistas e motociclistas, além de induzir danos materiais incomensuráveis, tanto em questão de propriedade particular quanto pública. Isto estimula países a buscarem métodos estimativos sobre os efeitos sociais, econômicos e epidemiológicos da taxa de mortes viárias e como se traduzem em custos e perdas na produtividade da sociedade em geral [@rodríguez2020].

A segurança viária é profundamente correlata ao estado de desenvolvimento de uma região, visto que é uma característica da mobilidade urbana. Entende-se que as mortes viárias dependem de diversos fatores estruturais, socioeconômicos e ambientais [@zhong-xiang2014]. Assim, elevadas taxas de sinistros colaboram no diagnóstico de problemas da segurança pública geral, despertando o debate político sobre a regulamentação das normas viárias e apontando a carência dos sistemas da união em combater estes eventos.

Enquanto o desenvolvimento econômico certamente beneficia a segurança viária, observa-se que os países da Assembleia Geral das Nações Unidas têm dificuldade em atingir as metas estabelecidas em 2015 pelos Objetivos de Desenvolvimento Sustentável. Apesar da crescente adesão por itens de segurança veicular, acidentes de transporte terrestre (ATTs) permanecem como um problema de saúde pública, visto que fazem parte de um agravo que repercute por toda a sociedade [@andrade2019], sendo a oitava causa de óbitos em todas as faixas etárias e a principal entre indivíduos de 5 a 29 anos [@worldhealthorganization2018]. Como previsto por modelos prévios à 2020 [@blumenberg2018], o Brasil falhou em reduzir sua mortalidade viária pela metade, como ditava a meta.

A busca pela fundamentação técnica para a proposição de políticas públicas a respeito da mobilidade segura fomenta o estudo de diversas categorias de modelos preditivos para a mortalidade, tanto para estimar o número de ocorrências quanto para avaliar a influência das variáveis consideradas. Modelos lineares multivariados são ajustados para extrair tendências sobre os critérios aferidos [@blumenberg2018; @cai2015], assim como modelos preditivos baseados em cadeia de Markov [@seneta1996; @jin2020]. Outras abordagens pretendem utilizar técnicas de análise de séries temporais, utilizando métodos como ARIMA [@al-ghamdi1995] e redes neurais artificiais [@jafari2015].

O presente estudo teve como objetivo criar um modelo linear de melhor ajuste para a previsão de mortes no trânsito em âmbito nacional no Brasil, investigando dados socioeconômicos, como o PIB e a população, extraídos pelo IBGE, assim como dados viários coletados das bases de dados da Polícia Federal Rodoviária (PRF), do Registro Nacional de Carteira de Habilitação (RENACH), do Registro Nacional de Veículos Automotores (RENAVAM) e do Sistema de Informação de Mortalidade (SIM) do Ministério da Saúde.

## Metodologia

A obtenção e tratamento dos dados de mortalidade foram efetuados a partir da API Microdatasus [@microdatasus], coletando dados a partir de 1996 até 2021. Esta escolha de intervalo temporal visa englobar a mortalidade estimada sob o protocolo da CID-10, pelo qual o banco de dados foi adequado ao estudo extraindo apenas as observações de mortes relacionadas a sinistros.

As demais variáveis, coletadas dos portais abertos, foram tratadas e imputadas em um único *dataframe*. Entre elas, a quantidade de automóveis, a quantidade de motocicletas, a quantidade total de veículos, o PIB, a população, a quantidade de acidentes, a quantidade de acidentes fatais, a quantidade de feridos em acidentes, a quantidade de mortos em acidentes e a quantidade de condutores. Em razão da ausência de dados prévios à 2011 de certas fontes, o intervalo de estudo foi reduzido para 2011 a 2021.

Assim sendo, a análise exploratória dos dados (AED) foi produzida para efetivar a validade dos dados e a significância delas para a construção do modelo. É observável que diversas variáveis possuem alto grau de colinearidade entre si, indicando que a modelagem utilizando todos os atributos poderia ser afetada por uma multicolinearidade e, consequentemente, superajuste. As correlações de Pearson, Spearman e Kendall são testadas e apresentam correlações elevadas para a maioria dos atributos.

```{r echo=FALSE}
cor_spearman <- df_total |> 
  drop_na() |>
  select(-quilometragem_10_bilhoes) |> 
  cor(method = c("spearman"))

ggcorrplot(cor_spearman, type = "lower",
              lab = TRUE, hc.order = T,
              lab_size = 2, tl.srt = 60,
              tl.cex = 8, legend.title = "Correlação",
              colors = c(onsv_palette$red,
                         onsv_palette$yellow,
                         onsv_palette$blue),
           title = "Correlograma dos atributos")

## 6in x 3.5in
```

As variáveis foram avaliadas em relação a sua frequência e densidade e foi considerado que, em geral, possuem comportamentos que devaneiam da normalidade em questão de suas distribuições de probabilidade. Por este motivo o método mais adequado utilizado para o cálculo dos coeficientes de correlação foi o de Spearman, visto que é uma medida não paramétrica. Em seguida, cada variável é testada com um modelo linear, tendo a quantidade de mortes como variável dependente para encontrar seus p-valores e métricas de erro quando investigadas individualmente.

Desta forma, a próxima etapa inclui a engenharia dos atributos para a otimização do modelo. O estudo inferencial mostra como diversas variáveis consideradas possuem alta colinearidade, congruente com as relações reais que uma categoria de dado viário têm com a ocorrência de outro. Por exemplo, a quantidade de mortes em sinistros de trânsito é diretamente dependente da quantidade de acidentes fatais, que por sua vez é resultante da quantidade de acidentes totais.

```{r echo=FALSE}
labels <- c(qnt_acidentes = "Acidentes", qnt_acidentes_fatais = "Acidentes Fatais",
            qnt_feridos = "Feridos")

prf_plot1 <- df_total |> 
  select(ano, qnt_acidentes_fatais, qnt_acidentes, qnt_feridos) |> 
  pivot_longer(-1) |>
  drop_na() |> 
  ggplot(aes(x = ano, y = value, color = name)) +
    geom_point(shape = 21, size = 1.5, stroke = 1.5) +
    geom_line(linewidth = 1, alpha = 0.25) +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = seq(2006, 2021, 1)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    ylab(label = "") +
    xlab("Ano")

theme_set(theme_onsv())

prf_plot1 + 
  labs(title = "Série Temporal de Acidentes") +
  scale_color_manual(labels = labels,
                               values = c(onsv_palette$red,
                                          onsv_palette$yellow,
                                          onsv_palette$blue))
```

Após a seleção das variáveis de melhor desempenho, o *dataframe* é padronizado a fim de otimizar sua performance e estabilidade no momento de ajuste. A expressão baseada na modelagem de uma regressão linear multivariada é feita e pode ser observada a partir dos coeficientes encontrados:

```{r include=FALSE}
metricas <- metric_set(rmse, mae, rsq)

df_preprocess <- df_total |> 
  select(
    ano,
    mortes,
    veiculos_total,
    qnt_acidentes_fatais,
    condutores,
    qnt_acidentes
  ) |> drop_na()

lm_recipe <- df_preprocess |> recipe(
  mortes ~
    veiculos_total +
    qnt_acidentes_fatais +
    condutores +
    qnt_acidentes
) |> step_normalize(all_numeric_predictors())

lm_reg <- linear_reg() |> set_engine("lm")

lm_wflow <- workflow() |> 
  add_recipe(lm_recipe) |> 
  add_model(lm_reg) |> 
  fit(df_preprocess)

coefs <- tidy(lm_wflow) |> arrange(p.value)

obs2022 <- list(
  "ano" = 2022,
  "qnt_acidentes" = 64547,
  "qnt_acidentes_fatais" = 4662,
  # "qnt_mortos" = 5439,
  # "qnt_feridos" = 72971,
  "condutores" = 79921178,
  "veiculos_total" = 115116532
  # "pib" = 9915317
) |> as.data.frame()

df_preprocess_2022 <- bind_rows(df_preprocess, obs2022)

df_pred <- lm_wflow |> 
  predict(df_preprocess_2022) |> 
  cbind(df_preprocess_2022)

df_pred <- lm_wflow |> 
  predict(df_preprocess_2022, type = "conf_int") |> 
  cbind(df_pred) |> 
  mutate(
    .variation = .pred_upper - .pred_lower 
  )

erros <- metricas(data =df_pred, truth = mortes, estimate = .pred)
```

```{r echo=FALSE}
coefs |>
  rename(Variável = term,
         Coeficiente = estimate,
         'P-valor' = p.value) |> 
  select(-std.error, -statistic)|> 
  mutate(
    Variável = case_match(
      Variável,
      "(Intercept)" ~ "Interceptação",
      "qnt_acidentes_fatais" ~ "Acidentes fatais",
      "veiculos_total" ~ "Veiculos",
      "condutores" ~ "Condutores",
      "qnt_acidentes" ~ "Acidentes"
    )
  ) |> 
  kable(caption = "Coeficientes")
```

## Discussão e Resultados

Devido ao fato de que a quantidade de dados é reduzida, é inviável a aplicação de técnicas de avaliação de modelo como a separação de conjuntos para treino e teste ou a validação cruzada (*Cross validation*). Por outro lado, a capacidade do algoritmo regressivo pode ser mensurada pelo comparação entre os dados de mortes iniciais com o produto encontrado pelo modelo.

```{r echo=FALSE}
modelo_linear <- 
  linear_reg() |> 
  set_engine("lm")

mortes_wflow <- 
  workflow() |> 
  add_recipe(lm_recipe) |> 
  add_model(modelo_linear)

mortes_wflow_ajustado <- mortes_wflow |> fit(df_total)
  
mortes_previsao <- mortes_wflow_ajustado |> predict(df_total) |> rename(mortes_pred = .pred)

mortes_previsao <- cbind(df_total, mortes_previsao)

mortes_previsao |> 
  select(mortes, mortes_pred, ano) |> 
  rename(Ano = ano, Previsto = mortes_pred, Real = mortes) |> 
  pivot_longer(cols = c(Previsto, Real), names_to = "Tipo", values_to = "Mortes") |> 
  ggplot(aes(x = Ano, y = Mortes, color = Tipo)) +
    geom_point(shape = 21, size = 1.5, stroke = 1.5) +
    geom_line(linewidth = 1, alpha = 0.25) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    scale_x_continuous(breaks = seq(1996, 2021, 1)) +
    labs(title = "Dados previstos e reais") +
    scale_discrete_onsv()
```

O modelo foi utilizado para prever a ocorrência de mortes relacionadas à segurança viária em 2022, recebendo como *input* os respectivos dados das bases anteriormente consultadas. A predição aponta a tendência anual das mortes, com limites de erro considerados em um intervalo de confiança.

```{r echo=FALSE}
df_pred |> 
  select(ano, .pred_lower, .pred_upper, .pred, mortes) |> 
  rename(Ano = ano, Previsto = .pred, Real = mortes) |> 
  pivot_longer(cols = c(Previsto, Real),
               names_to = "Tipo", values_to = "Mortes") |> 
  ggplot(aes(x = Ano, y = Mortes)) +
    geom_point(shape = 21, size = 1.5, stroke = 1.5, aes(color = Tipo)) +
    geom_line(linewidth = 1, alpha = 0.25, aes(color = Tipo)) +
    geom_ribbon(aes(ymin = .pred_lower, 
                    ymax = .pred_upper), 
                fill = "grey",
                alpha = 0.25,
                color = "grey") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    scale_x_continuous(breaks = seq(1996, 2022, 1)) +
    labs(title = "Previsões com intervalo de confiança até 2022") +
    scale_discrete_onsv()
```

Os métodos selecionados para aferir o modelo foram a Raiz Quadrada do Erro Médio (*Root Mean Squared Error* - RMSE), o Erro Médio Absoluto (*Mean Squared Error* - MAE) e o R-quadrado. Investigando as métricas de erros com base na comparação do conjunto de dados gerado ao inicial, têm-se:

```{r echo=FALSE}
erros |> 
  select(-.estimator) |> 
  mutate(
    .metric = case_match(
      .metric,
      "rmse" ~ "RMSE",
      "mae" ~ "MAE",
      "rsq" ~ "R²"
    )
  ) |> 
  rename(Métrica = .metric, Valor = .estimate) |> 
  kable(caption = "Métricas de Erros")

df_pred |> 
  select(.pred, mortes, ano) |> 
  rename(Previsto = .pred, Real = mortes) |> 
  ggplot(aes(x = Real, y = Previsto)) +
    geom_point(shape = 21, size = 1.5, stroke = 1.5, color = onsv_palette$blue) +
    geom_text(aes(label = ano), vjust = 1.5, size = 3) + 
    geom_abline(linewidth = 1, alpha = 0.25, color = onsv_palette$blue) +
    labs(title = "Mortes Previstas x Reais")
```

A valor obtido da previsão implica uma leve queda de 7,4% no número de mortes em relação ao ano anterior, que teria registrado 33813 casos. Conforme a análise dos dados, 2021 teria sido o segundo ano consecutivo a dispor de um aumento em fatalidades no trânsito. O intervalo de confiança mostra como este pode ser o caso de 2022 novamente, não obstante da diminuição prevista para as mortes. Ademais, é notável que apesar da intensidade das correlação dos preditores selecionados para o estudo, a resoluação temporal anual permanece como um gargálo para a análise dos sinistros viários já que a disponibilidade de dados é reduzida.

## Conclusão

O algoritmo desenvolvido permite inferir que há uma tendência perceptível nas mortes causadas pelo trânsito viário. Mesmo que as previsões demonstrem que há a possibilidade de redução nos anos subsequentes, é visível que a curvatura do modelo linear ajustado está substancialmente distante do número de casos de 2019, que foi o ano com a maior redução desde o pico de mortes em 2012. Isto revela um potencial relaxamento no sistema de segurança viária nacional, desencadeiando em uma redução em sua eficiência e propiciando um aumento na mortalidade. Por outro lado, há a hipótese de que este é o efeito direto da pandemia e do processo de reintegração da população ao trânsito após o período de isolamento social e *lockdown*.

É fundamental destacar que a abordagem de problemas de segurança viária não depende apenas de variáveis de mobilidade urbana. Existem diversos fatores infraestruturais e socioeconômicos que afetam a saúde deste sistema, sendo diretamente dependente do estado de desenvolvimento e maturidade tecnológica do país. O cenário atual da segurança viária brasileira anuncia alguns desafios e deficiências que podem impactar na conquista das metas sustentáveis estabelecidas em âmbito nacional e, caso este cenário não seja amenizado com antecedência, é improvável haverem avanços significativos nos objetivos da Agenda 2030.

## Referências
