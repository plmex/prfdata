---
title: "Modelo Preditivo de Mortes Viárias"
format: 
  html:
    editor: visual
bibliography: references.bib
toc: true
toc-title: Sumário
theme: lux
---

```{r include=FALSE}
# packages
library(tidyverse)
library(ggcorrplot)
library(onsvplot)
library(knitr)
library(here)
library(tidymodels)

# load dos dados
load(here("data","tabela_total.rda"))

# supressão dos warnings
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

## Introdução

O presente cenário mundial acerca de mortes e lesões relacionadas à sinistros viários posam sérios desafios à segurança pública global, e as tendências evidenciadas pelos dados contemporâneos indicam que este cenário perdura pelo futuro observável [@worldhealthorganization2018]. Sendo uma das causas de mortes evitáveis mais comuns no mundo, as ocorrências de acidentes afetam principalmente pedestres, ciclistas e motociclistas, além de induzir danos materiais incomensuráveis, tanto em questão de propriedade particular quanto pública, o que estimula países a buscarem métodos estimativos sobre os efeitos sociais, econômicos e epidemiológicos da taxa de mortes viárias e como se traduzem em custos e perdas na produtividade da sociedade em geral [@rodríguez2020].

A segurança viária é profundamente correlata ao estado de desenvolvimento de uma região, visto que é uma característica da mobilidade urbana. Entende-se que as mortes viárias dependem de diversos fatores estruturais, socioeconômicos e ambientais [@zhong-xiang2014]. Assim, elevadas taxas de sinistros colaboram no diagnóstico de problemas da segurança pública, estimulando o debate político sobre a regulamentação das normas viárias e apontando a carência dos sistemas da união em combater estes eventos.

Enquanto o desenvolimento econômico certamente beneficia a segurança viária, observa-se que os países da Assembléia Geral das Nações Unidas têm dificuldade em atingir as metas estabelecidas pelos Objetivos de Desenvolvimento Sustentável em 2015. Apesar da crescente adesão por itens de segurança veicular, acidentes de transporte terrestre (ATT) permanecem como um problema de saúde pública, visto que é uma questão que repercute por toda a sociedade [@andrade2019], sendo a oitava causa de óbitos em todas as faixas etária e a principal entre indivíduos de 5 a 29 anos [@worldhealthorganization2018]. Como previsto por modelos prévios à 2020 [@blumenberg2018], o Brasil falhou em reduzir sua mortalidade viária pela metade, como previa a meta.

A busca pela fundamentação técnica para a proposição de políticas públicas a respeito da mobilidade segura fomenta o estudo de diversas categorias de modelos preditivos para a mortalidade, tanto para estimar o número de ocorrências quanto para avaliar a influência das variáveis consideradas. Modelos lineares multivariados são ajustados para extrair tendências sobre os critérios aferidos [@blumenberg2018; @cai2015], assim como modelos preditivos baseados em cadeia de Markov [@seneta1996; @jin2020]. Outras abordagens pretendem utilizar técnicas de análise de séries temporais, utilizando métodos como ARIMA [@al-ghamdi1995] e redes neurais artificiais [@jafari2015].

O presente estudo teve como objetivo criar um modelo linear de melhor ajuste para a previsão de mortes no trânsito em âmbito nacional no Brasil, investigando dados sociocônimicos, como o PIB e a população extraídos pelo IBGE, assim como dados viários coletados das bases de dados da Polícia Federal Rodoviária (PRF), do Registro Nacional de Carteira de Habilitação (RENACH), do Registro Nacional de Veículos Automotores (RENAVAM) e do Sistema de Informação de Mortalidade (SIM) do Ministério da Saúde.

## Metodologia

A obtenção e tratamento dos dados de mortalidade foram efetuados a partir da API Microdatasus [@microdatasus], coletando dados a partir de 1996 até 2021. Esta escolha de intervalo temporal visa englobar a mortalidade estimada sob o protocolo da CID-10, pelo qual o banco de dados foi adequado ao estudo extraindo apenas as observações de mortes relacionadadas a ATTs. As demais variáveis, coletadas dos portais abertos, foram tratadas e imputadas em um único *dataframe*. Entre elas, a quantidade de automóveis, a quantidade de motocicletas, a quantidade total de veículos, o PIB, a população, a quantidade de acidentes, a quantidade de acidentes fatais, a quantidade de feridos em acidente, a quantidade de mortos em acidentes e a quantidade de condutores, todas em âmbito nacional.

Assim sendo, a análise exploratória dos dados (AED) foi produzida para efetivar a validade dos dados e a significância delas para a construção do modelo. É observável que diversas variáveis possuem alto grau de colinearidade entre si, indicando que a modelagem utilizando todos os atributos poderia ser afetada por uma multicolinearidade e, consequentemente, superajuste. As correlações de Pearson, Spearman e Kendall são testadas e, como indica a Figura X, apresentam correlações elevadas para a maioria dos atributos:

```{r echo=FALSE}
cor_spearman <- df_total |> 
  drop_na() |>
  select(-quilometragem_10_bilhoes) |> 
  cor(method = c("spearman"))

ggcorrplot(cor_spearman, type = "lower",
              lab = TRUE, hc.order = T,
              lab_size = 2, tl.srt = 60,
              tl.cex = 8, legend.title = "Correlação",
              colors = c(onsv_palette$red,
                         onsv_palette$yellow,
                         onsv_palette$blue))
```

As variáveis foram avaliadas em relação a sua frequência e densidade e foi considerado que, em geral, possuem comportamentos que devaneiam da normalidade em questão de suas distribuições de probabilidade. Por este motivo o método mais adequado utilizado para o cálculo dos coeficientes de correlação foi o de Spearman, visto que é uma medida não paramétrica. Em seguida, cada variável é testada com um modelo linear, tendo a quantidade de mortes como variável dependente para encontrar seus p-valores e métricas de erro quando investigadas individualmente.

Desta forma, o próximo passo inclue a engenharia dos atributos para a otimização do modelo. O estudo inferencial mostra como diversas variáveis consideradas possuem alta colinearidade, congruente com as relações reais que uma categoria de dado viário têm com a ocorrência de outro. Por exemplo, a quantidade de mortes em sinistros de trânsito é diretamente dependente da quantidade de acidentes fatais, que por sua vez é resultante da quantidade de acidentes totais.

```{r echo=FALSE}
labels <- c(qnt_acidentes = "Acidentes", qnt_acidentes_fatais = "Acidentes Fatais",
            qnt_feridos = "Feridos")

prf_plot1 <- df_total |> 
  select(ano, qnt_acidentes_fatais, qnt_acidentes, qnt_feridos) |> 
  pivot_longer(-1) |>
  drop_na() |> 
  ggplot(aes(x = ano, y = value, color = name)) +
    geom_point(shape = 21, size = 1.5, stroke = 1.5) +
    geom_line(linewidth = 1, alpha = 0.25) +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = seq(2006, 2021, 1)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    ylab(label = "") +
    xlab("Ano")

theme_set(theme_onsv())

prf_plot1 + scale_color_manual(labels = labels,
                               values = c(onsv_palette$red,
                                          onsv_palette$yellow,
                                          onsv_palette$blue))
```

Após a seleção das variáveis de melhor desempenho, o *dataframe* é padronizado a fim de otimizar sua performance e estabilidade no momento de ajuste. A expressão baseada na modelagem de uma regressão linear multivariada é feita e pode ser observada a partir dos coeficientes encontrados:

```{r include=FALSE}
metricas <- metric_set(rmse, mae, rsq)

df_preprocess <- df_total |> 
  select(
    ano,
    mortes,
    veiculos_total,
    qnt_acidentes_fatais,
    condutores,
    qnt_acidentes
  ) |> drop_na()

lm_recipe <- df_preprocess |> recipe(
  mortes ~
    veiculos_total +
    qnt_acidentes_fatais +
    condutores +
    qnt_acidentes
) |> step_normalize(all_numeric_predictors())

lm_reg <- linear_reg() |> set_engine("lm")

lm_wflow <- workflow() |> 
  add_recipe(lm_recipe) |> 
  add_model(lm_reg) |> 
  fit(df_preprocess)

coefs <- tidy(lm_wflow) |> arrange(p.value)

obs2022 <- list(
  "ano" = 2022,
  "qnt_acidentes" = 64547,
  "qnt_acidentes_fatais" = 4662,
  # "qnt_mortos" = 5439,
  # "qnt_feridos" = 72971,
  "condutores" = 79921178,
  "veiculos_total" = 115116532
  # "pib" = 9915317
) |> as.data.frame()

df_preprocess_2022 <- bind_rows(df_preprocess, obs2022)

df_pred <- lm_wflow |> 
  predict(df_preprocess_2022) |> 
  cbind(df_preprocess_2022)

df_pred <- lm_wflow |> 
  predict(df_preprocess_2022, type = "conf_int") |> 
  cbind(df_pred) |> 
  mutate(
    .variation = .pred_upper - .pred_lower 
  )

erros <- metricas(data =df_pred, truth = mortes, estimate = .pred)
```

```{r echo=FALSE}
coefs |>
  rename(Variavel = term,
         Coeficiente = estimate,
         'P-valor' = p.value) |> 
  select(-std.error, -statistic)|> 
  mutate(
    Variavel = case_match(
      Variavel,
      "(Intercept)" ~ "Intercept",
      "qnt_acidentes_fatais" ~ "Acidentes fatais",
      "veiculos_total" ~ "Veiculos",
      "condutores" ~ "Condutores",
      "qnt_acidentes" ~ "Acidentes"
    )
  ) |> 
  kable()
```

## Discussão e Resultados

Devido ao fato de que a quantidade de dados é reduzida, é inviável a aplicação de técnicas de avaliação de modelo como a separação de conjuntos para treino e teste ou a validação cruzada. Por outro lado, a capacidade do algoritmo regressor pode ser mensurada pelo comparação entre os dados de mortes iniciais com o produto encontrado pelo modelo.

```{r echo=FALSE}
mortes_previsao <- lm_wflow |> predict(df_total)
mortes_previsao <- cbind(df_total, mortes_previsao)

mortes_previsao |> 
  ggplot(aes(x = ano)) +
    geom_text(aes(label = ano, y = mortes), nudge_y = 750, size = 2.5) +
    geom_point(aes(y = mortes), color = onsv_palette$blue) +
    geom_line(aes(y = mortes), color = onsv_palette$blue, alpha = 0.75) +
    geom_point(aes(y = .pred), color = onsv_palette$red) +
    ylab("Mortes") +
    xlab("Ano")
```

O modelo foi utilizado para prever a ocorrência de mortes relacionadas à segurança viária em 2022, recebendo como *input* os respectivos dados das bases anteriormente consultadas. A predição aponta a tendência anual das mortes, com limites de erro considerados em um intervalo de confiança. 

```{r}
ggplot(data = df_pred, aes(x = ano, y = mortes)) +
  geom_point(color = onsv_palette$blue) +
  geom_point(aes(y = .pred), color = onsv_palette$red) +
  scale_x_continuous(breaks = seq(2006, 2022, 1))
```


## Conclusão

## Referências
